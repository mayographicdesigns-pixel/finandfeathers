<analysis>**original_problem_statement:**
The user wants to build a pixel-perfect clone of a restaurant's website. The project has evolved to include:
- A linktree-style homepage with a daily video carousel and navigation buttons.
- A dynamic menu page managed from a backend.
- A multi-location page system with a location-based check-in feature.
- A complete admin dashboard to manage all site content.
- PWA functionality with push notifications.
- A geolocation-based welcome popup.
- A My Account feature for users to manage their profile, view history, and interact with site content.
- An F&F token system for tipping and gifting.
- A role-based access control (RBAC) system with four tiers: Admin, Management, Staff, and Customer.
- A merchandise store integrated with WooCommerce.

**PRODUCT REQUIREMENTS:**
1.  **Homepage:** Linktree-style hub with a multi-video carousel, editable by an admin from the frontend.
2.  **Menu & Gallery Pages:** Data-driven from the backend.
3.  **Locations & Social Hub:** Geolocation check-in and a rich social hub.
4.  **Admin Dashboard:**
    *   CRUD for Menu, Gallery, Social Links, Videos, Locations, and location-specific Specials.
    *   **User & Role Management:** Admins can view all users, manage their roles (Admin, Management, Staff, Customer), and gift F&F tokens.
5.  **User Experience & My Account:**
    *   A My Account section for users to manage their profile and F&F tokens.
    *   **F&F Token Economy:** Users can purchase tokens, use them to tip staff/DJs, and gift drinks.
    *   **Role-Based Features:** Staff/DJs can collect tips and cash out.
6.  **Merchandise Store:** A new tab on the homepage that links to a page displaying products from the user's WooCommerce store.
7.  **Payment System:** All payments (token purchases, merchandise) must be handled through WooCommerce.

**User's preferred language**: English

**what currently exists?**
A feature-rich full-stack PWA with a React frontend and FastAPI backend.
- **Core Features:** An inline-editable homepage, admin-managed content (menu, gallery, locations, videos), and a comprehensive My Account page with profile management and role-based access control.
- **Recent Completions:**
    - Two critical bugs (a deployment blocker with  and a blank location page regression) were fixed.
    - Location data was successfully migrated from a static file to the backend, with full admin CRUD functionality.
    - A merchandise page that fetches and displays products from the user's WooCommerce store has been implemented.
    - A video management system was added to the admin panel to control the homepage video carousel.
- The application is currently in the middle of a major refactor to consolidate all payment processing through WooCommerce, replacing a short-lived Stripe integration.

**Last working item**:
-   Last item agent was working: The agent was refactoring the application to handle all payments via WooCommerce, as requested by the user. This included three main parts:
    1.  Replacing the token purchase flow (previously Stripe) with a new system that creates a WooCommerce order.
    2.  Implementing an in-app cart system for the merchandise page, leading to a WooCommerce checkout.
    3.  Ensuring in-app actions like tipping remained token-based.
    The agent had started modifying backend endpoints in  and updating frontend API calls in .
-   Status: IN PROGRESS
-   Agent Testing Done: N
-   Which testing method agent to use? both
-   User Testing Done: N

**All Pending/In progress Issue list**:
-   Issue 1: Complete the migration of all payment systems to WooCommerce. (P0)

  Issues Detail:
  - Issue 1: 
     - Attempted fixes: The agent started creating new backend endpoints in  (, ) and removing the Stripe SDK. Frontend modifications were started in  and  to accommodate the new flow.
     - Next debug checklist:
        1.  **Backend ():**
            - Finalize the  and  endpoints to ensure they correctly create WooCommerce orders and return a checkout URL.
            - **Implement a new webhook handler ()** to listen for  events, which will credit tokens to the user's account. This is a critical missing piece.
            - Completely remove all remaining Stripe-related code and dependencies.
        2.  **Frontend:**
            - Refactor  to remove all Stripe logic and use the new WooCommerce token purchase endpoint, redirecting the user to the checkout URL.
            - Implement a cart state management solution (e.g., React Context or  in a parent component).
            - Update  to include Add to Cart functionality on products.
            - Create a new Cart component (modal or page) to display cart contents and a Checkout button that uses the new  endpoint.
     - Why fix this issue and what will be achieved with the fix?: This will unify the application's payment system under a single provider as requested by the user, simplifying maintenance and creating a consistent user experience.
     - Status: IN PROGRESS
     - Is recurring issue?: N
     - Should Test frontend/backend/both after fix?: both
     - Blocked on other issue: None

**In progress Task List**:
- None, as the current focus is on the P0 issue above.

**Upcoming and Future Tasks**
-   Upcoming Tasks:
    -   (P1) Geolocation Sorting: On the main  page, sort the list of restaurants by the user's proximity.
    -   (P2) Location-Specific Content: Allow other content (besides specials) to be managed on a per-location basis.
-   Future Tasks:
    -   (P2) Enhance Merchandise Store: Add features like product search, more detailed product pages, and viewing order history within the app.

**Completed work in this session**
- **Critical Bug Fixes:**
  - Resolved / deployment blocker by pinning .
  - Verified that the blank location pages bug was not reproducible.
- **Location Data Migration:** Migrated location data from  to a MongoDB collection with a full admin CRUD interface.
- **WooCommerce Merchandise Store:** Implemented a  page that dynamically loads products from the user's WooCommerce store.
- **Admin Video Management:** Created a new Videos tab in the admin panel for full CRUD management of the homepage video carousel.
- **Payment Integration (Iterative):**
    - Implemented and then began removing a Stripe-based token purchase system.
    - Began the implementation of a unified WooCommerce payment system for both tokens and merchandise.
- **Testing:** Successfully used the testing agent to validate the location, merchandise, and video features before starting the payment refactor.

**Earlier issues found/mentioned but not fixed**
-   None. The major technical debt of using  for locations has been resolved.

**Known issue recurrence from previous fork**
-   None. The previously recurring blank location pages issue was investigated and found to be non-reproducible.

**Code Architecture**


**Key Technical Concepts**
-   **Frontend:** React, React Router, TailwindCSS, PWA, Shadcn UI
-   **Backend:** FastAPI, MongoDB (Motor), Pydantic
-   **Architecture:** Full-stack monolith, REST API, Role-Based Access Control (RBAC)
-   **Integrations:** WooCommerce API

**key DB schema**
-   :  (New)
-   :  (New)
-   : (Unchanged, but  will now be updated via WooCommerce webhooks)

**changes in tech stack**
-    added to the backend for asynchronous API calls to WooCommerce.
-    library and integration are being actively removed.
-    version pinned to  to resolve a dependency conflict.

**All files of reference**
-   : Core file for the ongoing WooCommerce integration and removal of Stripe.
-   : Frontend component for token purchases, currently being refactored.
-   : The new merchandise store page that will need cart functionality.
-   : Contains all new and modified API client functions.
-   : Contains the new admin tabs for locations and videos.
-   : Contains the WooCommerce API credentials.

**Areas that need refactoring**:
-   The primary refactoring task is the complete removal of the Stripe integration code from , , and  once the WooCommerce replacement is fully functional and tested.

**key api endpoints**
-    & : (CRUD for locations) **(NEW & WORKING)**
-   : (Get WooCommerce products) **(NEW & WORKING)**
-    & : (CRUD for promo videos) **(NEW & WORKING)**
-   : (Create WC order for tokens) **(IN PROGRESS)**
-   : (Create WC order from in-app cart) **(IN PROGRESS)**
-   : (To process completed orders) **(NOT STARTED)**
-    & : (Stripe-related endpoints) **(DEPRECATED / BEING REMOVED)**

**Critical Info for New Agent**
-   **Your top priority is to complete the migration to WooCommerce for all payments.** The user has explicitly requested this.
-   The most critical missing part is the **backend webhook handler** to process completed WooCommerce orders and credit tokens to users. Without this, the purchase flow is incomplete.
-   The frontend needs a **cart system** for the merchandise page. This does not exist yet and needs to be built from scratch.
-   WooCommerce API keys are already in . You do not need to ask the user for them.
-   Once the WooCommerce migration is done, you should use the testing agent to perform a full regression test on the payment flows for both tokens and merchandise.

**documents and test reports created in this job**
-    (Continuously updated)
-   Multiple reports in  confirming the stability of features implemented before the payment refactor.

**Last 10 User Messages and any pending HUMAN messages** 
1.  **Request:** Fix token purchasing (it's not prompting for payment). Also asked about admin user management. - **Status: In Progress (led to current task)**
2.  **User Choice:** Chose Stripe for payment integration. - **Status: Superseded**
3.  **Request:** Add a merchandise tab using WooCommerce and fix the menu page. - **Status: Completed (Merch tab done, menu was already working)**
4.  **User Choice:** Chose to integrate the merchandise store directly into the app (Option B). - **Status: Completed**
5.  **User Input:** Provided WooCommerce API keys. - **Status: Completed**
6.  **Request:** Use the WooCommerce API for ALL payments. - **Status: In Progress**
7.  **User Clarification:**
    - Token purchases should create a WooCommerce order.
    - Merchandise should have an in-app cart and checkout via WooCommerce.
    - Tipping/gifting drinks should remain token-based. - **Status: In Progress (This defines the current task)**

**Project Health Check:**
-   **Broken:**
    -   The token purchasing feature is currently non-functional as it is in the middle of a refactor from Stripe to WooCommerce.
-   **Mocked:**
    -   None.

**3rd Party Integrations**
-   **WooCommerce:** Used for both merchandise display and all payment processing. Requires User API Key (already provided and in ).
-   **@dnd-kit:** Used for drag-and-drop on the homepage.
-   **passlib/bcrypt:** Used for password hashing.

**Testing status**
-   Testing agent used after significant changes: YES (for locations, videos, and merch page).
-   Troubleshoot agent used after agent stuck in loop: NO
-   Test files created: None.
-   Known regressions: The token purchase flow is intentionally broken during the refactor.

**Credentials to test flow:**
-   **Admin Panel:**
    -   **URL:** 
    -   **Username:** 
    -   **Password:** 
-   **WooCommerce Credentials:** Available in .

**What agent forgot to execute**
-   The previous agent did not complete the full WooCommerce payment migration. Key missing components are the backend webhook handler to confirm purchases and the entire frontend cart UI for merchandise.</analysis>
